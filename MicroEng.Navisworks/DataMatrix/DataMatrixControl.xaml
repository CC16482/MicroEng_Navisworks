<UserControl x:Class="MicroEng.Navisworks.DataMatrixControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:local="clr-namespace:MicroEng.Navisworks"
             xmlns:system="clr-namespace:System;assembly=System"
             mc:Ignorable="d"
             d:DesignHeight="600"
             d:DesignWidth="900"
             Background="{DynamicResource ApplicationBackgroundBrush}"
             Foreground="{DynamicResource TextFillColorPrimaryBrush}"
             FontSize="12">

    <UserControl.Resources>
        <ResourceDictionary>
            <system:Double x:Key="ControlContentThemeFontSize">12</system:Double>
            <Style x:Key="ColumnHeaderFilterButtonStyle" TargetType="{x:Type ui:Button}">
                <Setter Property="Width" Value="22" />
                <Setter Property="Height" Value="22" />
                <Setter Property="MinWidth" Value="22" />
                <Setter Property="MinHeight" Value="22" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="Margin" Value="6,0,0,0" />
                <Setter Property="Appearance" Value="Secondary" />
                <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}" />
                <Setter Property="BorderThickness" Value="1" />
                <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}" />
                <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type ui:Button}">
                            <Border x:Name="ButtonBorder"
                                    CornerRadius="4"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}">
                                <ContentPresenter HorizontalAlignment="Center"
                                                  VerticalAlignment="Center" />
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="ButtonBorder" Property="Background" Value="{DynamicResource ControlFillColorTertiaryBrush}" />
                                </Trigger>
                                <Trigger Property="IsPressed" Value="True">
                                    <Setter TargetName="ButtonBorder" Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}" />
                                    <Setter TargetName="ButtonBorder" Property="BorderBrush" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Opacity" Value="0.5" />
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
            <DataTemplate x:Key="DataMatrixColumnHeaderTemplate">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="{Binding Title}"
                               VerticalAlignment="Center"
                               TextTrimming="CharacterEllipsis"
                               Margin="0,0,4,0"
                               Foreground="{DynamicResource TextFillColorPrimaryBrush}" />
                    <ui:Button Grid.Column="1"
                               Style="{StaticResource ColumnHeaderFilterButtonStyle}"
                               Click="ColumnFilterButton_Click"
                               ToolTip="Filter column">
                        <ui:SymbolIcon RenderTransformOrigin="0.5,0.5">
                            <ui:SymbolIcon.RenderTransform>
                                <RotateTransform Angle="180" />
                            </ui:SymbolIcon.RenderTransform>
                            <ui:SymbolIcon.Style>
                                <Style TargetType="{x:Type ui:SymbolIcon}">
                                    <Setter Property="Symbol" Value="BeakerOff20" />
                                    <Setter Property="Filled" Value="False" />
                                    <Setter Property="FontSize" Value="14" />
                                    <Setter Property="Foreground" Value="{Binding Foreground, RelativeSource={RelativeSource AncestorType={x:Type ui:Button}}}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsFiltered}" Value="True">
                                            <Setter Property="Symbol" Value="Beaker20" />
                                            <Setter Property="Filled" Value="True" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:SymbolIcon.Style>
                        </ui:SymbolIcon>
                    </ui:Button>
                </Grid>
            </DataTemplate>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="{x:Static local:MicroEngResourceUris.WpfUiRoot}" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <ui:Card Grid.Row="0"
                 Padding="10"
                 Margin="0,0,0,8"
                 HorizontalAlignment="Stretch"
                 HorizontalContentAlignment="Stretch"
                 VerticalContentAlignment="Top">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Title -->
                <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Vertical">
                    <ui:TextBlock Text="Data Matrix" FontSize="16" FontWeight="SemiBold" />
                    <ui:TextBlock Text="Tabular view of the latest scrape session."
                                  Margin="0,4,0,0"
                                  FontSize="12"
                                  Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                </StackPanel>

                <!-- Scope pill removed -->

                <!-- Toolbar: three single-column rows -->
                <StackPanel Grid.Row="1" Grid.ColumnSpan="2" Margin="0,10,0,0">
                    <WrapPanel VerticalAlignment="Center" Margin="0,0,0,6">
                        <TextBlock Text="Data Source:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <ComboBox x:Name="ProfileCombo" Width="180" Margin="0,0,8,0" />
                        <ui:Button x:Name="RefreshProfilesButton"
                                   Width="36"
                                   Height="30"
                                   Padding="0"
                                   Margin="0,0,6,0"
                                   ToolTip="Refresh">
                            <ui:SymbolIcon Symbol="ArrowSync20" FontSize="20" />
                        </ui:Button>
                        <ui:Button x:Name="OpenDataScraperButton"
                                   Width="36"
                                   Height="30"
                                   Padding="0"
                                   Margin="0,0,14,0"
                                   ToolTip="Open Data Scraper">
                            <ui:SymbolIcon Symbol="DatabaseLightning20" FontSize="18" />
                        </ui:Button>

                        <TextBlock Text="Scope:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <ComboBox x:Name="ScopeCombo"
                                  Width="170"
                                  Margin="0,0,8,0"
                                  ToolTip="Choose how to filter items for this schedule.">
                            <ComboBoxItem Content="Entire session" Tag="EntireSession" />
                            <ComboBoxItem Content="Current selection" Tag="CurrentSelection" />
                            <ComboBoxItem Content="Selection set" Tag="SelectionSet" />
                            <ComboBoxItem Content="Search set" Tag="SearchSet" />
                            <ComboBoxItem Content="Single item" Tag="SingleItem" />
                        </ComboBox>

                        <TextBlock x:Name="ScopeSetLabel"
                                   Text="Set:"
                                   VerticalAlignment="Center"
                                   Margin="0,0,6,0"
                                   Visibility="Collapsed"/>

                        <ComboBox x:Name="ScopeSetCombo"
                                  Width="220"
                                  Margin="0,0,8,0"
                                  IsEnabled="False"
                                  Visibility="Collapsed"
                                  ToolTip="Choose a saved Selection/Search Set (only when scope uses sets)." />

                        <ui:Button x:Name="RefreshScopeSetsButton"
                                   Content="Refresh Sets"
                                   Margin="0,0,12,0"
                                   Visibility="Collapsed"
                                   ToolTip="Reload Selection/Search set names from the model." />
                    </WrapPanel>

                    <WrapPanel VerticalAlignment="Center" Margin="0,0,0,6">
                        <TextBlock Text="View:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <ComboBox x:Name="ViewPresetCombo" Width="170" Margin="0,0,8,0" />
                        <ui:Button x:Name="SaveViewButton" Content="Save" Margin="0,0,8,0"/>
                        <ui:Button x:Name="SaveViewAsButton" Content="Save As" Margin="0,0,8,0"/>
                        <ui:Button x:Name="DeleteViewButton" Content="Delete" Margin="0,0,14,0"/>
                    </WrapPanel>

                    <WrapPanel VerticalAlignment="Center">
                        <ui:Button x:Name="ColumnsButton"
                                   Content="Column Builder"
                                   Appearance="Primary" Foreground="{DynamicResource TextFillColorInverseBrush}" FontWeight="Bold"
                                   Padding="12,6"
                                   Margin="0,0,14,0"/>
                        <ui:ToggleSwitch x:Name="SyncToggle" OffContent="Sync selection" OnContent="Sync selection" Margin="0,0,14,0" />
                        <CheckBox x:Name="SelectedOnlyCheck"
                                  Content="Selected only"
                                  Margin="0,0,14,0"
                                  IsThreeState="False" />
                        <ui:DropDownButton Content="Export">
                            <ui:DropDownButton.Flyout>
                                <ContextMenu>
                                    <MenuItem Header="Filtered to CSV..." x:Name="ExportFilteredMenu"/>
                                    <MenuItem Header="All to CSV..." x:Name="ExportAllMenu"/>
                                    <Separator />
                                    <MenuItem Header="Export JSONL (Item docs) - Filtered" x:Name="ExportJsonlItemFilteredMenu" />
                                    <MenuItem Header="Export JSONL (Item docs) - All" x:Name="ExportJsonlItemAllMenu" />
                                    <MenuItem Header="Export JSONL (Raw rows) - Filtered" x:Name="ExportJsonlRawFilteredMenu" />
                                    <MenuItem Header="Export JSONL (Raw rows) - All" x:Name="ExportJsonlRawAllMenu" />
                                </ContextMenu>
                            </ui:DropDownButton.Flyout>
                        </ui:DropDownButton>
                    </WrapPanel>
                </StackPanel>

            </Grid>
        </ui:Card>

        <!-- Data grid -->
        <ui:Card Grid.Row="1"
                 Padding="0"
                 Margin="0,0,0,8"
                 HorizontalAlignment="Stretch"
                 HorizontalContentAlignment="Stretch"
                 VerticalAlignment="Stretch"
                 VerticalContentAlignment="Stretch">

            <ui:DataGrid x:Name="MatrixGrid"
                         AutoGenerateColumns="False"
                         IsReadOnly="True"
                         CanUserAddRows="False"
                         CanUserDeleteRows="False"
                         CanUserResizeColumns="True"
                         CanUserReorderColumns="True"
                         SelectionMode="Extended"
                         SelectionUnit="FullRow"
                         ClipboardCopyMode="IncludeHeader"
                         GridLinesVisibility="All"
                         HorizontalGridLinesBrush="{DynamicResource MicroEngDataGridGridLineBrush}"
                         VerticalGridLinesBrush="{DynamicResource MicroEngDataGridGridLineBrush}"
                         FontSize="12"
                         RowHeight="28"
                         ColumnHeaderHeight="30"
                         EnableRowVirtualization="True"
                         EnableColumnVirtualization="True"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         Sorting="MatrixGrid_Sorting"
                         SelectionChanged="MatrixGrid_SelectionChanged"
                         PreviewMouseRightButtonDown="MatrixGrid_PreviewMouseRightButtonDown">
                <ui:DataGrid.ColumnHeaderStyle>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="VerticalContentAlignment" Value="Center" />
                        <Setter Property="Padding" Value="6,0,4,0" />
                        <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}" />
                        <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                        <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}" />
                        <Setter Property="BorderThickness" Value="0,0,0,1" />
                        <Setter Property="SnapsToDevicePixels" Value="True" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="DataGridColumnHeader">
                                    <Grid SnapsToDevicePixels="True">
                                        <Border x:Name="HeaderBorder"
                                                Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}">
                                            <ContentPresenter Margin="{TemplateBinding Padding}"
                                                              HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                              RecognizesAccessKey="True" />
                                        </Border>
                                        <Thumb x:Name="PART_LeftHeaderGripper"
                                               HorizontalAlignment="Left"
                                               Background="Transparent"
                                               Width="6"
                                               Cursor="SizeWE"
                                               Opacity="0" />
                                        <Thumb x:Name="PART_RightHeaderGripper"
                                               HorizontalAlignment="Right"
                                               Background="Transparent"
                                               Width="6"
                                               Cursor="SizeWE"
                                               Opacity="0" />
                                    </Grid>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="HeaderBorder" Property="Background" Value="{DynamicResource ControlFillColorTertiaryBrush}" />
                                        </Trigger>
                                        <Trigger Property="IsPressed" Value="True">
                                            <Setter TargetName="HeaderBorder" Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}" />
                                        </Trigger>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.6" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ui:DataGrid.ColumnHeaderStyle>

                <ui:DataGrid.ContextMenu>
                    <ContextMenu Opened="MatrixGrid_ContextMenu_Opened">
                        <MenuItem Header="Copy"
                                  Command="ApplicationCommands.Copy"
                                  CommandTarget="{Binding PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>

                        <MenuItem Header="Copy cell"
                                  Tag="CopyCell"
                                  Click="CopyCellMenu_Click"/>

                        <MenuItem Header="Copy row(s) as CSV (with headers)"
                                  Tag="CopyRowsCsv"
                                  Click="CopyRowsCsvMenu_Click"/>

                        <Separator/>

                        <MenuItem Header="Copy Item GUID"
                                  Tag="CopyGuid"
                                  Click="CopyGuidMenu_Click"/>

                        <MenuItem Header="Select in model"
                                  Tag="SelectInModel"
                                  Click="SelectInModelMenu_Click"/>
                    </ContextMenu>
                </ui:DataGrid.ContextMenu>

            </ui:DataGrid>

        </ui:Card>

        <!-- Status bar -->
        <ui:Card Grid.Row="2"
                 Padding="10"
                 HorizontalAlignment="Stretch"
                 HorizontalContentAlignment="Stretch"
                 VerticalContentAlignment="Center">

            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="0">
                <TextBlock x:Name="RowsStatus"
                           Text="Rows: 0"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           Margin="0,0,12,0"/>

                <TextBlock x:Name="ProfileStatus"
                           Text="Profile: -"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           Margin="0,0,12,0"/>

                <TextBlock x:Name="ScopeStatus"
                           Text="Scope: -"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           Margin="0,0,12,0"/>

                <TextBlock x:Name="SelectionStatus"
                           Text="Selected: 0"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           Margin="0,0,12,0"/>

                <TextBlock x:Name="ViewStatus"
                           Text="View: (Default)"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
            </StackPanel>
        </ui:Card>

        <ui:SnackbarPresenter x:Name="SnackbarPresenter"
                              Grid.RowSpan="3"
                              Margin="0,0,0,4"
                              VerticalAlignment="Bottom"
                              HorizontalAlignment="Center"
                              Panel.ZIndex="10" />
    </Grid>
</UserControl>
