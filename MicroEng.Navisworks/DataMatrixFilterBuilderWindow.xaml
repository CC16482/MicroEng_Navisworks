<Window x:Class="MicroEng.Navisworks.DataMatrixFilterBuilderWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:local="clr-namespace:MicroEng.Navisworks"
        xmlns:system="clr-namespace:System;assembly=System"
        x:ClassModifier="internal"
        x:Name="RootWindow"
        Title="Filter Builder"
        Width="720"
        MinWidth="640"
        SizeToContent="Height"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource ApplicationBackgroundBrush}"
        Foreground="{DynamicResource TextFillColorPrimaryBrush}"
        FontSize="12">
    <Window.Resources>
        <ResourceDictionary>
            <local:FilterValueEnabledConverter x:Key="FilterValueEnabledConverter" />
            <local:JoinEnabledConverter x:Key="JoinEnabledConverter" />
            <system:Double x:Key="ControlContentThemeFontSize">12</system:Double>
            <SolidColorBrush x:Key="FilterBuilderCountBrush" Color="#2F80FF" />
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="{x:Static local:MicroEngResourceUris.WpfUiRoot}" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <ui:Card Grid.Row="0" Padding="12" Margin="0,0,0,6">
            <StackPanel>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0">
                        <ui:TextBlock Text="Filter Builder" FontSize="18" FontWeight="SemiBold" />
                        <ui:TextBlock Text="Build rules for this column and apply them to the table."
                                      Margin="0,4,0,0"
                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                        <ui:TextBlock Text="{Binding ElementName=RootWindow, Path=ColumnLabel}"
                                      Margin="0,4,0,0"
                                      FontWeight="SemiBold"
                                      Foreground="{DynamicResource AccentFillColorDefaultBrush}" />
                    </StackPanel>
                </Grid>
                <ui:Button x:Name="AddRuleButton"
                           Content="Add Rule"
                           Appearance="Primary" Foreground="{DynamicResource TextFillColorInverseBrush}" FontWeight="Bold"
                           Padding="12,6"
                           Margin="0,6,0,0"
                           HorizontalAlignment="Center" />
            </StackPanel>
        </ui:Card>

        <ui:Card Grid.Row="1" Padding="0" Margin="0,0,0,4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <DockPanel Grid.Row="0" Margin="12,10,12,6">
                    <ui:TextBlock Text="Rules" FontWeight="SemiBold" DockPanel.Dock="Left" />
                    <ui:TextBlock Text="{Binding ElementName=RulesGrid, Path=Items.Count, StringFormat=' - {0} rules'}"
                                  Margin="8,0,0,0"
                                  Foreground="{StaticResource FilterBuilderCountBrush}"
                                  DockPanel.Dock="Left" />
                </DockPanel>

                <ui:DataGrid x:Name="RulesGrid"
                             Grid.Row="1"
                             AutoGenerateColumns="False"
                             CanUserAddRows="False"
                             CanUserDeleteRows="False"
                             CanUserResizeColumns="True"
                             CanUserReorderColumns="False"
                             IsReadOnly="False"
                             HeadersVisibility="Column"
                             RowHeight="28"
                             ColumnHeaderHeight="30"
                             GridLinesVisibility="None"
                             SelectionMode="Single"
                             SelectionUnit="Cell"
                             AlternationCount="200000"
                             Margin="6,0,6,4">
                    <ui:DataGrid.Columns>
                        <DataGridCheckBoxColumn Header="On"
                                                Binding="{Binding IsEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                Width="50" />
                        <DataGridTemplateColumn Header="Join" Width="70">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding ElementName=RootWindow, Path=JoinOptions}"
                                              DisplayMemberPath="Label"
                                              SelectedValuePath="Join"
                                              SelectedValue="{Binding Join, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              MinWidth="60">
                                        <ComboBox.IsEnabled>
                                            <MultiBinding Converter="{StaticResource JoinEnabledConverter}">
                                                <Binding ElementName="RulesGrid" Path="ItemsSource" />
                                                <Binding RelativeSource="{RelativeSource AncestorType=DataGridRow}" Path="(ItemsControl.AlternationIndex)" />
                                            </MultiBinding>
                                        </ComboBox.IsEnabled>
                                    </ComboBox>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Operator" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding ElementName=RootWindow, Path=OperatorOptions}"
                                              DisplayMemberPath="Label"
                                              SelectedValuePath="Operator"
                                              SelectedValue="{Binding Operator, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              MinWidth="140" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Value" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ui:TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                IsEnabled="{Binding Operator, Converter={StaticResource FilterValueEnabledConverter}}"
                                                Margin="0" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridCheckBoxColumn Header="Case"
                                                Binding="{Binding CaseSensitive, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                Width="60" />
                        <DataGridCheckBoxColumn Header="Trim"
                                                Binding="{Binding TrimWhitespace, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                Width="60" />
                        <DataGridTemplateColumn Header="" Width="80">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ui:Button Padding="6,2"
                                               ToolTip="Delete"
                                               Click="DeleteRuleButton_Click"
                                               Foreground="{DynamicResource SystemFillColorCriticalBrush}">
                                        <ui:SymbolIcon Symbol="Dismiss12"
                                                       Filled="True"
                                                       FontSize="14"
                                                       Foreground="{DynamicResource SystemFillColorCriticalBrush}" />
                                    </ui:Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </ui:DataGrid.Columns>
                </ui:DataGrid>
            </Grid>
        </ui:Card>

        <Grid Grid.Row="2" Margin="0,2,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <ui:TextBlock x:Name="ErrorText"
                          Grid.Column="0"
                          Foreground="{DynamicResource SystemFillColorCriticalBrush}"
                          VerticalAlignment="Center"
                          TextWrapping="Wrap" />
            <StackPanel Grid.Column="1"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right">
                <ui:Button x:Name="ApplyButton"
                           Content="Apply"
                           Appearance="Primary" Foreground="{DynamicResource TextFillColorInverseBrush}" FontWeight="Bold"
                           Padding="12,6"
                           Margin="0,0,6,0" />
                <ui:Button x:Name="CancelButton"
                           Content="Cancel"
                           Appearance="Secondary"
                           Padding="12,6" />
            </StackPanel>
        </Grid>
    </Grid>
</Window>
