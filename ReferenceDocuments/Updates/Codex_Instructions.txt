Got it — I’ve updated the plan to use the two-row toolbar layout for the Data Matrix UI.


Below are the **3 deliverables** (Codex instructions + concrete XAML + the required code-behind/model changes) to get you to a clean **two-row toolbar** in **DataMatrixControl** (only). I did **not** touch Column Builder.

---

## 1) Codex instructions (what to implement)

**Goal:** Replace the single WrapPanel toolbar with a **3-row header**:

* **Row 0:** Title (left) + **scope pill** (right)
* **Row 1:** Primary controls (left: Data Source + Refresh + Scope + optional Set picker) + (right: View + Save)
* **Row 2:** Secondary actions (left: Save As + Delete + Column Builder + Sync + Selected only) + (right: Export)

**Rules:**

* Keep all existing control names (`ProfileCombo`, `ScopeCombo`, `ScopeSetCombo`, `RefreshScopeSetsButton`, `ViewPresetCombo`, etc.) so your existing code-behind wiring still works.
* Add these new named UI elements:

  * `ScopeBadgeText` (TextBlock in the pill)
  * `ScopeSetLabel` (TextBlock “Set:” shown only for Selection/Search Set scopes)
  * `ScopeStatus` and `SelectionStatus` in the status bar
* Make the **Set picker row elements collapsed** by default in XAML and let code-behind toggle `Visibility`.
* (Optional but recommended) Make the grid `IsReadOnly="True"` and add a simple row context menu (copy cell/rows, select in model) without touching Column Builder.

---

## 2) Two-row toolbar layout (XAML)

### ✅ Drop-in updated file

I generated a ready-to-use updated XAML file:

* [Download DataMatrixControl.updated.xaml](sandbox:/mnt/data/DataMatrixControl.updated.xaml)

If you’d rather copy/paste, the key change is the **Header Grid** with 3 rows and two toolbars (Row 1 + Row 2). That’s already baked into the downloaded file.

**What this gives you immediately**

* A cleaner header layout (no WrapPanel “run-on”)
* Better right-side alignment for View/Save and Export
* Scope pill that can reflect the actual scope state

---

## 3) Required code changes (to support the new header + better UX)

Because the new XAML introduces new named elements (`ScopeBadgeText`, `ScopeSetLabel`, `ScopeStatus`, `SelectionStatus`) and collapses the Set controls by default, you need small supporting changes in code-behind.

### ✅ Drop-in updated file

* [Download DataMatrixControl.updated.xaml.cs](sandbox:/mnt/data/DataMatrixControl.updated.xaml.cs)

This version includes:

* **Two-row toolbar support**
* Scope pill + status text updates
* Showing/hiding the Set picker based on scope
* Selection count in the status bar
* (Optional UX) Right-click row select + context menu copy helpers
* (QoL) Save/restore **column order** and **column widths** in the preset (still *Data Matrix UI only*)

### Model update (preset stores widths)

If you want the “save widths/order” QoL, add two fields to the preset model.

✅ Drop-in updated file:

* [Download DataMatrixModels.updated.cs](sandbox:/mnt/data/DataMatrixModels.updated.cs)

**What it adds to `DataMatrixViewPreset`:**

* `ElementColumnWidth`
* `ColumnWidths` dictionary keyed by AttributeId

---

## Minimal patch version (if you don’t want the full updated .cs)

If you only want what’s necessary for **two-row toolbar + scope pill + Set picker visibility**, these are the essentials:

### A) In `RefreshScopeSets(...)` add visibility toggles

```csharp
var enableSets = kind == DataMatrixScopeKind.SelectionSet || kind == DataMatrixScopeKind.SearchSet;
ScopeSetCombo.IsEnabled = enableSets;

// Only show the Set picker when it is relevant.
ScopeSetLabel.Visibility = enableSets ? Visibility.Visible : Visibility.Collapsed;
ScopeSetCombo.Visibility = enableSets ? Visibility.Visible : Visibility.Collapsed;
RefreshScopeSetsButton.Visibility = enableSets ? Visibility.Visible : Visibility.Collapsed;

if (!enableSets) return;
```

### B) Add `UpdateScopeUiText()` and call it after scope changes

```csharp
private void UpdateScopeUiText()
{
    var kind = GetScopeKindFromUi();
    var label = kind switch
    {
        DataMatrixScopeKind.EntireSession => "Entire session",
        DataMatrixScopeKind.CurrentSelection => "Current selection",
        DataMatrixScopeKind.SelectionSet => "Selection set",
        DataMatrixScopeKind.SearchSet => "Search set",
        DataMatrixScopeKind.SingleItem => "Single item",
        _ => kind.ToString()
    };

    if (kind == DataMatrixScopeKind.SelectionSet || kind == DataMatrixScopeKind.SearchSet)
    {
        var set = GetSelectedScopeSetName();
        if (!string.IsNullOrWhiteSpace(set)) label = $"{label}: {set}";
    }

    var text = $"Scope: {label}";
    if (ScopeBadgeText != null) ScopeBadgeText.Text = text;
    if (ScopeStatus != null) ScopeStatus.Text = text;
}
```

Call it in:

* `OnScopeChanged()` after `RefreshScopeSets()`
* `OnScopeSetChanged()` before rebuild
* `SetScopeUi(...)` after `RefreshScopeSets(setName)`

### C) Add selection status update

```csharp
private void UpdateSelectionStatus()
{
    if (SelectionStatus == null) return;
    SelectionStatus.Text = $"Selected: {MatrixGrid?.SelectedItems?.Count ?? 0}";
}
```

And call it from `MatrixGrid_SelectionChanged(...)` even when sync is off.

---

## Note about your uploaded files

One of the tools I use to search across uploads reports that **some earlier uploaded files are no longer searchable** (expired in the index). If you want me to cross-check **MicroEngWpfUiRoot.xaml / MicroEngUiKit.xaml** or anything else for consistency/styling, re-upload those specific XAML resource dictionaries and I’ll wire the toolbar visuals to match your theme perfectly.

---

If you apply the two downloads (`DataMatrixControl.updated.xaml` + `DataMatrixControl.updated.xaml.cs`), you’ll have the **two-row toolbar layout** immediately, with scope clarity and better usability—without touching Column Builder.
